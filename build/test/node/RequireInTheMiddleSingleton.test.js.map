{"version":3,"file":"RequireInTheMiddleSingleton.test.js","sourceRoot":"","sources":["../../../test/node/RequireInTheMiddleSingleton.test.ts"],"names":[],"mappings":"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","sourcesContent":["/*\n * Copyright The OpenTelemetry Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as assert from 'assert';\nimport * as sinon from 'sinon';\nimport * as path from 'path';\nimport * as RequireInTheMiddle from 'require-in-the-middle';\nimport { RequireInTheMiddleSingleton } from '../../src/platform/node/RequireInTheMiddleSingleton';\n\nconst requireInTheMiddleSingleton = RequireInTheMiddleSingleton.getInstance();\n\ntype AugmentedExports = {\n  __ritmOnRequires?: string[];\n};\n\nconst makeOnRequiresStub = (label: string): sinon.SinonStub =>\n  sinon.stub().callsFake(((exports: AugmentedExports) => {\n    exports.__ritmOnRequires ??= [];\n    exports.__ritmOnRequires.push(label);\n    return exports;\n  }) as RequireInTheMiddle.OnRequireFn);\n\ndescribe('RequireInTheMiddleSingleton', () => {\n  describe('register', () => {\n    const onRequireFsStub = makeOnRequiresStub('fs');\n    const onRequireFsPromisesStub = makeOnRequiresStub('fs-promises');\n    const onRequireCodecovStub = makeOnRequiresStub('codecov');\n    const onRequireCodecovLibStub = makeOnRequiresStub('codecov-lib');\n    const onRequireCpxStub = makeOnRequiresStub('cpx');\n    const onRequireCpxLibStub = makeOnRequiresStub('cpx-lib');\n\n    before(() => {\n      requireInTheMiddleSingleton.register('fs', onRequireFsStub);\n      requireInTheMiddleSingleton.register(\n        'fs/promises',\n        onRequireFsPromisesStub\n      );\n      requireInTheMiddleSingleton.register('codecov', onRequireCodecovStub);\n      requireInTheMiddleSingleton.register(\n        'codecov/lib/codecov.js',\n        onRequireCodecovLibStub\n      );\n      requireInTheMiddleSingleton.register('cpx', onRequireCpxStub);\n      requireInTheMiddleSingleton.register(\n        'cpx/lib/copy-sync.js',\n        onRequireCpxLibStub\n      );\n    });\n\n    beforeEach(() => {\n      onRequireFsStub.resetHistory();\n      onRequireFsPromisesStub.resetHistory();\n      onRequireCodecovStub.resetHistory();\n      onRequireCodecovLibStub.resetHistory();\n      onRequireCpxStub.resetHistory();\n      onRequireCpxLibStub.resetHistory();\n    });\n\n    it('should return a hooked object', () => {\n      const moduleName = 'm';\n      const onRequire = makeOnRequiresStub('m');\n      const hooked = requireInTheMiddleSingleton.register(\n        moduleName,\n        onRequire\n      );\n      assert.deepStrictEqual(hooked, { moduleName, onRequire });\n    });\n\n    describe('core module', () => {\n      describe('AND module name matches', () => {\n        it('should call `onRequire`', () => {\n          const exports = require('fs');\n          assert.deepStrictEqual(exports.__ritmOnRequires, ['fs']);\n          sinon.assert.calledOnceWithExactly(\n            onRequireFsStub,\n            exports,\n            'fs',\n            undefined\n          );\n          sinon.assert.notCalled(onRequireFsPromisesStub);\n        });\n      });\n      describe('AND module name does not match', () => {\n        it('should not call `onRequire`', () => {\n          const exports = require('crypto');\n          assert.equal(exports.__ritmOnRequires, undefined);\n          sinon.assert.notCalled(onRequireFsStub);\n        });\n      });\n    });\n\n    describe('core module with sub-path', () => {\n      describe('AND module name matches', () => {\n        it('should call `onRequire`', () => {\n          const exports = require('fs/promises');\n          assert.deepStrictEqual(exports.__ritmOnRequires, ['fs-promises']);\n          sinon.assert.calledOnceWithExactly(\n            onRequireFsPromisesStub,\n            exports,\n            'fs/promises',\n            undefined\n          );\n          sinon.assert.notCalled(onRequireFsStub);\n        });\n      });\n    });\n\n    describe('non-core module', () => {\n      describe('AND module name matches', () => {\n        const baseDir = path.dirname(require.resolve('codecov'));\n        const modulePath = path.join('codecov', 'lib', 'codecov.js');\n        it('should call `onRequire`', () => {\n          const exports = require('codecov');\n          assert.deepStrictEqual(exports.__ritmOnRequires, ['codecov']);\n          sinon.assert.calledWithExactly(\n            onRequireCodecovStub,\n            exports,\n            'codecov',\n            baseDir\n          );\n          sinon.assert.calledWithMatch(\n            onRequireCodecovStub,\n            { __ritmOnRequires: ['codecov', 'codecov-lib'] },\n            modulePath,\n            baseDir\n          );\n          sinon.assert.calledWithMatch(\n            onRequireCodecovLibStub,\n            { __ritmOnRequires: ['codecov', 'codecov-lib'] },\n            modulePath,\n            baseDir\n          );\n        }).timeout(30000);\n      });\n    });\n\n    describe('non-core module with sub-path', () => {\n      describe('AND module name matches', () => {\n        const baseDir = path.resolve(\n          path.dirname(require.resolve('cpx')),\n          '..'\n        );\n        const modulePath = path.join('cpx', 'lib', 'copy-sync.js');\n        it('should call `onRequire`', () => {\n          const exports = require('cpx/lib/copy-sync');\n          assert.deepStrictEqual(exports.__ritmOnRequires, ['cpx', 'cpx-lib']);\n          sinon.assert.calledWithMatch(\n            onRequireCpxStub,\n            { __ritmOnRequires: ['cpx', 'cpx-lib'] },\n            modulePath,\n            baseDir\n          );\n          sinon.assert.calledWithExactly(\n            onRequireCpxStub,\n            exports,\n            modulePath,\n            baseDir\n          );\n          sinon.assert.calledWithExactly(\n            onRequireCpxLibStub,\n            exports,\n            modulePath,\n            baseDir\n          );\n        });\n      });\n    });\n  });\n});\n"]}