{"version":3,"file":"RequireInTheMiddleSingleton.test.js","sourceRoot":"","sources":["../../../test/node/RequireInTheMiddleSingleton.test.ts"],"names":[],"mappings":"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","sourcesContent":["/*\n * Copyright The OpenTelemetry Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as assert from 'assert';\nimport * as sinon from 'sinon';\nimport * as path from 'path';\nimport * as RequireInTheMiddle from 'require-in-the-middle';\nimport { RequireInTheMiddleSingleton } from '../../src/platform/node/RequireInTheMiddleSingleton';\n\nconst requireInTheMiddleSingleton = RequireInTheMiddleSingleton.getInstance();\n\ntype AugmentedExports = {\n  __ritmOnRequires?: string[]\n};\n\nconst makeOnRequiresStub = (label: string): sinon.SinonStub => sinon.stub().callsFake(((exports: AugmentedExports) => {\n  exports.__ritmOnRequires ??= [];\n  exports.__ritmOnRequires.push(label);\n  return exports;\n}) as RequireInTheMiddle.OnRequireFn);\n\ndescribe('RequireInTheMiddleSingleton', () => {\n  describe('register', () => {\n    const onRequireFsStub = makeOnRequiresStub('fs');\n    const onRequireFsPromisesStub = makeOnRequiresStub('fs-promises');\n    const onRequireCodecovStub = makeOnRequiresStub('codecov');\n    const onRequireCodecovLibStub = makeOnRequiresStub('codecov-lib');\n    const onRequireCpxStub = makeOnRequiresStub('cpx');\n    const onRequireCpxLibStub = makeOnRequiresStub('cpx-lib');\n\n    before(() => {\n      requireInTheMiddleSingleton.register('fs', onRequireFsStub);\n      requireInTheMiddleSingleton.register('fs/promises', onRequireFsPromisesStub);\n      requireInTheMiddleSingleton.register('codecov', onRequireCodecovStub);\n      requireInTheMiddleSingleton.register('codecov/lib/codecov.js', onRequireCodecovLibStub);\n      requireInTheMiddleSingleton.register('cpx', onRequireCpxStub);\n      requireInTheMiddleSingleton.register('cpx/lib/copy-sync.js', onRequireCpxLibStub);\n    });\n\n    beforeEach(() => {\n      onRequireFsStub.resetHistory();\n      onRequireFsPromisesStub.resetHistory();\n      onRequireCodecovStub.resetHistory();\n      onRequireCodecovLibStub.resetHistory();\n      onRequireCpxStub.resetHistory();\n      onRequireCpxLibStub.resetHistory();\n    });\n\n    it('should return a hooked object', () => {\n      const moduleName = 'm';\n      const onRequire = makeOnRequiresStub('m');\n      const hooked = requireInTheMiddleSingleton.register(moduleName, onRequire);\n      assert.deepStrictEqual(hooked, { moduleName, onRequire });\n    });\n\n    describe('core module', () => {\n      describe('AND module name matches', () => {\n        it('should call `onRequire`', () => {\n          const exports = require('fs');\n          assert.deepStrictEqual(exports.__ritmOnRequires, ['fs']);\n          sinon.assert.calledOnceWithExactly(onRequireFsStub, exports, 'fs', undefined);\n          sinon.assert.notCalled(onRequireFsPromisesStub);\n        });\n      });\n      describe('AND module name does not match', () => {\n        it('should not call `onRequire`', () => {\n          const exports = require('crypto');\n          assert.equal(exports.__ritmOnRequires, undefined);\n          sinon.assert.notCalled(onRequireFsStub);\n        });\n      });\n    });\n\n    describe('core module with sub-path', () => {\n      describe('AND module name matches', () => {\n        it('should call `onRequire`', () => {\n          const exports = require('fs/promises');\n          assert.deepStrictEqual(exports.__ritmOnRequires, ['fs', 'fs-promises']);\n          sinon.assert.calledOnceWithExactly(onRequireFsPromisesStub, exports, 'fs/promises', undefined);\n          sinon.assert.calledOnceWithMatch(onRequireFsStub, { __ritmOnRequires: ['fs', 'fs-promises'] }, 'fs/promises', undefined);\n        });\n      });\n    });\n\n    describe('non-core module', () => {\n      describe('AND module name matches', () => {\n        const baseDir = path.dirname(require.resolve('codecov'));\n        const modulePath = path.join('codecov', 'lib', 'codecov.js');\n        it('should call `onRequire`', () => {\n          const exports = require('codecov');\n          assert.deepStrictEqual(exports.__ritmOnRequires, ['codecov']);\n          sinon.assert.calledWithExactly(onRequireCodecovStub, exports, 'codecov', baseDir);\n          sinon.assert.calledWithMatch(onRequireCodecovStub, { __ritmOnRequires: ['codecov', 'codecov-lib'] }, modulePath, baseDir);\n          sinon.assert.calledWithMatch(onRequireCodecovLibStub, { __ritmOnRequires: ['codecov', 'codecov-lib'] }, modulePath, baseDir);\n        }).timeout(30000);\n      });\n    });\n\n    describe('non-core module with sub-path', () => {\n      describe('AND module name matches', () => {\n        const baseDir = path.resolve(path.dirname(require.resolve('cpx')), '..');\n        const modulePath = path.join('cpx', 'lib', 'copy-sync.js');\n        it('should call `onRequire`', () => {\n          const exports = require('cpx/lib/copy-sync');\n          assert.deepStrictEqual(exports.__ritmOnRequires, ['cpx', 'cpx-lib']);\n          sinon.assert.calledWithMatch(onRequireCpxStub, { __ritmOnRequires: ['cpx', 'cpx-lib'] }, modulePath, baseDir);\n          sinon.assert.calledWithExactly(onRequireCpxStub, exports, modulePath, baseDir);\n          sinon.assert.calledWithExactly(onRequireCpxLibStub, exports, modulePath, baseDir);\n        });\n      });\n    });\n  });\n});\n"]}